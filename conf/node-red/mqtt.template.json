{
    "id": "MQTT Flow Format",
    "label": "{{.Params.FlowId}}",
    "info": "",
    "nodes": [
        {{if .Enable}}
            {{.Params.AddTopicList | convJsonStr}},
        {{else}}
            {{.Params.AddDisTopicList | convJsonStr}},
        {{end}}
        {
            "id":"TS-MQTT-HTTPIN-STATUS-{{.Params.UUID}}",
            "type":"http in",
            "name":"",
            "url":"/mqtt/{{.Params.UUID}}/status",
            "method":"get",
            "upload":false,
            "swaggerDoc":"",
            "x":270,
            "y":140,
            "wires":[  
               [  
                  "TS-MQTT-HTTPIN-PARSE-{{.Params.UUID}}"
               ]
            ]
        },
        {  
            "id":"TS-MQTT-HTTPIN-PARSE-{{.Params.UUID}}",
            "type":"function",
            "name":"",
            "func":"const {url} = msg.req;\nconst list = url.split(\"/\");\nconst id = list[list.length-2];\nconst status = global.get('ts-status');\nmsg.payload = status[id];\nreturn msg;",
            "outputs":1,
            "noerr":0,
            "x":490,
            "y":140,
            "wires":[  
               [  
                  "TS-MQTT-HTTPIN-MQTT-{{.Params.UUID}}",
                  "TS-MQTT-HTTPIN-RESPONSE-{{.Params.UUID}}"
               ]
            ]
        },
        {  
            "id":"TS-MQTT-HTTPIN-RESPONSE-{{.Params.UUID}}",
            "type":"http response",
            "name":"",
            "statusCode":"",
            "headers":{
            },
            "x":670,
            "y":160,
            "wires":[[]]
        },
        {  
            "id":"TS-MQTT-HTTPIN-MQTT-{{.Params.UUID}}",
            "type":"mqtt out",
            "name":"",
            "topic":"/thingspin/connect/{{.Params.UUID}}/status",
            "qos":"2",
            "retain":"true",
            "broker":"TS-MQTT-TSBROKER-{{.Params.UUID}}",
            "x":950,
            "y":140,
            "wires":[[]]
         },
        {  
            "id":"TS-MQTT-COMMENT-{{.Params.UUID}}",
            "type":"comment",
            "name":"MQTT-{{.Params.Name}}",
            "info":"",
            "x":80,
            "y":20,
            "wires":[[]]
        }, {
            "id": "TS-MQTT-STATUS-{{.Params.UUID}}",
            "type": "status",
            "name": "",
            "scope": ["TS-MQTT-CHECKNODE-{{.Params.UUID}}"],
            "x": 200,
            "y": 60,
            "wires": [
                ["TS-MQTT-STATUS-DATA-PROCESS-{{.Params.UUID}}"]
            ]
        }, {
            "id": "TS-MQTT-STATUS-DATA-PROCESS-{{.Params.UUID}}",
            "type": "function",
            "name": "Data Process",
            "func": "const { status } = msg;\nconst stat = global.get('ts-status') || {};\nif(stat[status.source.name] !== status.fill) {\n    msg.payload = status.fill;\n}\nstat[status.source.name] = status.fill;\nglobal.set('ts-status', stat);\nreturn msg;",
            "outputs": 1,
            "noerr": 0,
            "x": 490,
            "y": 60,
            "wires": [
                ["TS-MQTT-MQTTOUT-{{.Params.UUID}}"]
            ]
        }, {
            "id": "TS-MQTT-MQTTOUT-{{.Params.UUID}}",
            "type": "mqtt out",
            "name": "",
            "topic": "/thingspin/connect/{{.Params.UUID}}/status",
            "qos": "2",
            "retain": "true",
            "broker": "TS-MQTT-TSBROKER-{{.Params.UUID}}",
            "x": 830,
            "y": 60,
            "wires": []
        }, {
            "id":"TS-MQTT-INJECT-{{.Params.UUID}}",
            "type":"inject",
            "name":"",
            "topic":"",
            "payload":"",
            "payloadType":"date",
            "repeat":"1",
            "crontab":"",
            "once":false,
            "onceDelay":0.1,
            "x":210,
            "y":100,
            "wires":[  
               [  
                  "TS-MQTT-PARSING-INJECT-{{.Params.UUID}}"
               ]
            ]            
        }, {  
            "id":"TS-MQTT-PARSING-INJECT-{{.Params.UUID}}",
            "type":"function",
            "name":"",
            "func":"",
            "outputs":1,
            "noerr":0,
            "x":490,
            "y":100,
            "wires":[  
               [  
                  "TS-MQTT-CHECKNODE-{{.Params.UUID}}"
               ]
            ]
         }, {
            "id": "TS-MQTT-TSBROKER-{{.Params.UUID}}",
            "type": "mqtt-broker",
            "broker": "localhost",
            "port": "1883",
            "clientid": "",
            "usetls": false,
            "compatmode": true,
            "keepalive": "60",
            "cleansession": true,
            "birthTopic": "",
            "birthQos": "0",
            "birthPayload": "",
            "closeTopic": "",
            "closeQos": "0",
            "closePayload": "",
            "willTopic": "",
            "willQos": "0",
            "willPayload": ""
        },
        {
            "id": "TS-MQTT-OUTPUT-{{.Params.UUID}}",
            "type": "influxdb batch",
            "influxdb": "TS-MQTT-INFLUXD-{{.Params.UUID}}",
            "precision": "",
            "retentionPolicy": "",
            "name": "",
            "x": 830,
            "y": 220,
            "wires": []
        },
        {
            "id": "TS-MQTT-CONNECT-{{.Params.UUID}}",
            "type": "mqtt-broker",
            "name": "{{.Params.Host}}",
            "broker": "{{.Params.Host}}",
            "port": "{{.Params.Port}}",
            "clientid": "",
            "usetls": false,
            "compatmode": true,
            "keepalive": "{{.Params.KeepAlive}}",
            "cleansession": "{{.Params.Session}}",
            "birthTopic": "",
            "birthQos": "0",
            "birthPayload": "",
            "closeTopic": "",
            "closeQos": "0",
            "closePayload": "",
            "willTopic": "",
            "willQos": "0",
            "willPayload": ""
        },
        {
            "id": "TS-MQTT-INFLUXD-{{.Params.UUID}}",
            "type": "influxdb",
            "z": "",
            "hostname": "{{.TsSettings.Influx.Host}}",
            "port": "{{.TsSettings.Influx.Port}}",
            "protocol": "http",
            "database": "{{.TsSettings.Influx.Database}}",
            "name": "",
            "usetls": false,
            "tls": ""
        }
    ]
}